if(_.isUndefined(TFilter)){var TFilter={},AttributesCollection=Backbone.Collection.extend({url:function(){return $("#website_url").val()+"api/filtering/filters/"}});TFilter.Attributes=new AttributesCollection;TFilter.MainView=Backbone.View.extend({tags:[],events:{"change .plugin-filtering-attribute-widget input":"saveAttributeValue","keyup [name=new-attribute]":"attachAttribute"},initialize:function(){this.lists={};this.$tabs=this.$el.find("div.plugin-filtering-builder-content");this.$tabs.tabs();
this.$tabs.on("tabsactivate",_.bind(this.initTagsBlock,this));this.data=this.$el.data();var a=this;this.$el.find("input.typeahead").autocomplete({source:_.bind(this.autocomplete,this),focus:function(a,b){return!1},select:function(c,b){a.renderAttribute(b.item);$(this).val("").blur();return!1}})},setTags:function(a){_.isEmpty(a)||(this.tags=a);return this},getTags:function(){return this.tags},attachAttribute:function(a){a.preventDefault();if(13===a.keyCode){var c=this,b=$(a.currentTarget),d=b.val(),
e=[];a=TFilter.Attributes.find(function(a){return a.get("label")===d});_.each(this.$el.find(".apply-to-tags input:checkbox:checked"),function(a){e.push($(a).val())});a?(c.renderAttribute(_.extend({tags:e},a.toJSON())),b.val("").blur()):TFilter.Attributes.create({label:d},{success:function(a,d){b.val("").blur();var f={attribute_id:a.get("id"),label:a.get("label"),name:a.get("name"),tags:e};c.renderAttribute(f)},error:function(a,b){showMessage(b.responseText,!0)}})}},initTagsBlock:function(){var a=
this.getCurrentScope(),c="";_.has(this.tags,a)&&(_.isEmpty(this.tags[a])?c="<label>This "+a+" has no tags yet</label>":_.each(this.tags[a],function(a){c+='<label><input type="checkbox" name="tags[]" value="'+a.id+'" />'+_.escape(a.name)+"</label>"}));this.$el.find(".apply-to-tags").html(c)},loadAttributes:function(a){_.isEmpty(a)||_.each(a,this.renderAttribute,this)},renderAttribute:function(a,c){_.has(a,"scope")||(a.scope=this.getCurrentScope());_.has(this.lists,a.scope)||(this.lists[a.scope]=this.$el.find(".filters-list[data-list="+
a.scope+"]"));var b=[];_.has(a,"tags")&&(b=a.tags);$("<p>",{"class":"plugin-filtering-attribute-widget"}).data({aid:a.attribute_id,scope:a.scope,tags:b}).append($("<label>").html(a.label)).append($("<input>",{type:"text",name:a.name,value:_.unescape(a.value)})).appendTo(this.lists[a.scope])},getCurrentScope:function(){var a=this.$("div.plugin-filtering-builder-content").tabs("option","active");return this.$("div[role=tabpanel]:eq("+a+")").find(".filters-list").data("list")},saveAttributeValue:function(a){var c=
$(a.currentTarget);a=c.closest(".plugin-filtering-attribute-widget").data();var b={entity_id:this.data[a.scope],attribute_id:a.aid,value:c.val(),scope:a.scope};_.has(a,"tags")&&(b.tags=a.tags);$.ajax({url:$("#website_url").val()+"api/filtering/eav/",type:"PUT",data:JSON.stringify(b),success:function(a){c.val(_.unescape(a.value))}})},autocomplete:function(a,c){var b=$.ui.autocomplete.escapeRegex(a.term).toLowerCase(),d=_.chain(TFilter.Attributes.toJSON()).filter(function(a){return-1!==a.label.toLowerCase().search(b)}).map(function(a){return{attribute_id:a.id,
label:a.label,value:null}}).value();c(d)}});$(function(){TFilter.Attributes.fetch()})};
