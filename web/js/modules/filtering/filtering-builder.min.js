if(_.isUndefined(TFilter)){var TFilter={},AttributesCollection=Backbone.Collection.extend({url:function(){return $("#website_url").val()+"api/filtering/filters/"}});TFilter.Attributes=new AttributesCollection;TFilter.MainView=Backbone.View.extend({tags:[],events:{"change .filtering-attribute-widget input":"saveAttributeValue","keyup [name=new-attribute]":"attachAttribute"},initialize:function(){this.productId=this.$el.data("productid");this.$tabs=this.$el.find("div.plugin-filtering-builder-content");
this.$tabs.tabs();this.$tabs.on("tabsactivate",_.bind(this.initTagsBlock,this));this.data=this.$el.data();var a=this;this.$el.find("input.typeahead").autocomplete({source:_.bind(this.autocomplete,this),focus:function(a,c){return!1},select:function(b,c){a.renderAttribute(c.item);$(this).val("").blur();return!1}})},setTags:function(a){_.isEmpty(a)||(this.tags=a);return this},getTags:function(){return this.tags},attachAttribute:function(a){a.preventDefault();if(13===a.keyCode){var b=this,c=$(a.currentTarget),
d=c.val(),e=[];a=TFilter.Attributes.find(function(a){return a.get("label")===d});_.each(this.$el.find(".apply-to-tags input:checkbox:checked"),function(a){e.push($(a).val())});a?(b.renderAttribute(_.extend({tags:e},a.toJSON())),c.val("").blur()):TFilter.Attributes.create({label:d},{success:function(a,d){c.val("").blur();var f={attribute_id:a.get("id"),label:a.get("label"),name:a.get("name"),tags:e};b.renderAttribute(f)},error:function(a,b){showMessage(b.responseText,!0)}})}},initTagsBlock:function(){var a=
"";_.isEmpty(this.tags)?a="<label>This product has no tags yet</label>":_.each(this.tags,function(b){a+='<label><input type="checkbox" name="tags[]" value="'+b.id+'" />'+_.escape(b.name)+"</label>"});this.$el.find(".apply-to-tags").html(a)},loadAttributes:function(a){_.isEmpty(a)||_.each(a,this.renderAttribute,this)},renderAttribute:function(a,b){_.isUndefined(this.list)&&(this.list=this.$el.find(".product-filters-list"));var c=[];_.has(a,"tags")&&(c=a.tags);$("<p>",{"class":"filtering-attribute-widget"}).append($("<label>").html(a.label)).append($("<input>",
{type:"text",name:a.name,value:_.unescape(a.value)}).data({aid:a.attribute_id,tags:c})).appendTo(this.list)},saveAttributeValue:function(a){var b=$(a.currentTarget);a={product_id:this.productId,attribute_id:b.data("aid"),tags:b.data("tags"),value:b.val()};$.ajax({url:$("#website_url").val()+"api/filtering/eav/",type:"PUT",data:JSON.stringify(a),success:function(a){b.val(_.unescape(a.value))}})},autocomplete:function(a,b){var c=$.ui.autocomplete.escapeRegex(a.term).toLowerCase(),d=_.chain(TFilter.Attributes.toJSON()).filter(function(a){return-1!==
a.label.toLowerCase().search(c)}).map(function(a){return{attribute_id:a.id,label:a.label,value:null}}).value();b(d)}});$(function(){TFilter.Attributes.fetch()})};
