define(["Underscore","Backbone"],function(c,l){var k={version:"0.15"};k.clientPager=l.Collection.extend({initialize:function(){this.useLevenshteinPlugin=this.useDiacriticsPlugin=!0;this.sortColumn="";this.sortDirection="desc";this.lastSortColumn="";this.fieldFilterRules=[];this.lastFieldFilterRiles=[];this.lastFilterExpression=this.filterExpression=this.filterFields=""},sync:function(a,g,d){var e=this;c.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10});c.each(e.paginator_ui,
function(b,a){c.isUndefined(e[a])&&(e[a]=e.paginator_ui[a])});var f={};c.each(e.server_api,function(b,a){c.isFunction(b)&&(b=c.bind(b,e),b=b());f[a]=b});var b=c.clone(e.paginator_core);c.each(b,function(a,g){c.isFunction(a)&&(a=c.bind(a,e),a=a());b[g]=a});b=c.defaults(b,{timeout:25E3,cache:!1,type:"GET",dataType:"jsonp"});b=c.extend(b,{jsonpCallback:"callback",data:decodeURIComponent($.param(f)),processData:!1,url:c.result(b,"url")},d);return $.ajax(b)},nextPage:function(){this.currentPage=++this.currentPage;
this.pager()},previousPage:function(){this.currentPage=--this.currentPage||1;this.pager()},goTo:function(a){void 0!==a&&(this.currentPage=parseInt(a,10),this.pager())},howManyPer:function(a){if(void 0!==a){var c=this.perPage;this.perPage=parseInt(a,10);this.currentPage=Math.ceil((c*(this.currentPage-1)+1)/a);this.pager()}},setSort:function(a,c){void 0!==a&&void 0!==c&&(this.lastSortColumn=this.sortColumn,this.sortColumn=a,this.sortDirection=c,this.pager(),this.info())},setFieldFilter:function(a){c.isEmpty(a)||
(this.lastFieldFilterRiles=this.fieldFilterRules,this.fieldFilterRules=a,this.pager(),this.info())},setFilter:function(a,c){void 0!==a&&void 0!==c&&(this.filterFields=a,this.lastFilterExpression=this.filterExpression,this.filterExpression=c,this.pager(),this.info())},pager:function(){var a=this.perPage,g=(this.currentPage-1)*a,d=g+a;void 0===this.origModels&&(this.origModels=this.models);this.models=this.origModels;""!==this.sortColumn&&(this.models=this._sort(this.models,this.sortColumn,this.sortDirection));
c.isEmpty(this.fieldFilterRules)||(this.models=this._fieldFilter(this.models,this.fieldFilterRules));""!==this.filterExpression&&(this.models=this._filter(this.models,this.filterFields,this.filterExpression));this.lastSortColumn===this.sortColumn&&this.lastFilterExpression===this.filterExpression&&c.isEqual(this.fieldFilterRules,this.lastFieldFilterRiles)||(g=0,d=g+a,this.currentPage=1,this.lastSortColumn=this.sortColumn,this.lastFieldFilterRiles=this.fieldFilterRules,this.lastFilterExpression=this.filterExpression);
this.sortedAndFilteredModels=this.models;this.reset(this.models.slice(g,d))},_sort:function(a,c,d){return a=a.sort(function(a,f){var b=a.get(c),h=f.get(c);if(b&&h)b=b.toString().toLowerCase(),h=h.toString().toLowerCase();else return 0;if("desc"===d)if(!b.match(/[^\d\.]/)&&b.match(/[\d\.]*/)&&!h.match(/[^\d\.]/)&&h.match(/[\d\.]*/)){if(b-0<h-0)return 1;if(b-0>h-0)return-1}else{if(b<h)return 1;if(b>h)return-1}else if(!b.match(/[^\d\.]/)&&b.match(/[\d\.]*/)&&!h.match(/[^\d\.]/)&&h.match(/[\d\.]*/)){if(b-
0<h-0)return-1;if(b-0>h-0)return 1}else{if(b<h)return-1;if(b>h)return 1}return 0})},_fieldFilter:function(a,g){if(c.isEmpty(g))return a;var d=[];c.each(a,function(a){var f=!0;c.each(g,function(b){if(!f)return!1;f=!1;"function"===b.type?c.wrap(b.value,function(c){return c(a.get(b.field))})()&&(f=!0):"required"===b.type?c.isEmpty(a.get(b.field).toString())||(f=!0):"min"===b.type?!c.isNaN(Number(a.get(b.field)))&&(!c.isNaN(Number(b.value))&&Number(a.get(b.field))>=Number(b.value))&&(f=!0):"max"===b.type?
!c.isNaN(Number(a.get(b.field)))&&(!c.isNaN(Number(b.value))&&Number(a.get(b.field))<=Number(b.value))&&(f=!0):"range"===b.type?!c.isNaN(Number(a.get(b.field)))&&(c.isObject(b.value)&&!c.isNaN(Number(b.value.min))&&!c.isNaN(Number(b.value.max))&&Number(a.get(b.field))>=Number(b.value.min)&&Number(a.get(b.field))<=Number(b.value.max))&&(f=!0):"minLength"===b.type?a.get(b.field).toString().length>=b.value&&(f=!0):"maxLength"===b.type?a.get(b.field).toString().length<=b.value&&(f=!0):"rangeLength"===
b.type?c.isObject(b.value)&&(!c.isNaN(Number(b.value.min))&&!c.isNaN(Number(b.value.max))&&a.get(b.field).toString().length>=b.value.min&&a.get(b.field).toString().length<=b.value.max)&&(f=!0):"oneOf"===b.type?c.isArray(b.value)&&c.include(b.value,a.get(b.field))&&(f=!0):"equalTo"===b.type?b.value===a.get(b.field)&&(f=!0):"pattern"===b.type?a.get(b.field).toString().match(b.value)&&(f=!0):f=!1});f&&d.push(a)});return d},_filter:function(a,g,d){var e=this,f={};c.isString(g)?f[g]={cmp_method:"regexp"}:
c.isArray(g)?c.each(g,function(a){f[a]={cmp_method:"regexp"}}):c.each(g,function(a,b){f[b]=c.defaults(a,{cmp_method:"regexp"})});g=f;c.has(l.Paginator,"removeDiacritics")&&e.useDiacriticsPlugin&&(d=l.Paginator.removeDiacritics(d));if(""!==d&&c.isString(d))var b=d.match(/\w+/ig),h="("+c.uniq(b).join("|")+")",n=RegExp(h,"igm");else return a;var k=[];c.each(a,function(a){var h=[];c.each(g,function(g,f){var m=a.get(f);if(m){var k=[],m=c.has(l.Paginator,"removeDiacritics")&&e.useDiacriticsPlugin?l.Paginator.removeDiacritics(m.toString()):
m.toString();"levenshtein"===g.cmp_method&&c.has(l.Paginator,"levenshtein")&&e.useLevenshteinPlugin?(m=l.Paginator.levenshtein(m,d),c.defaults(g,{max_distance:0}),m<=g.max_distance&&(k=c.uniq(b))):k=m.match(n);k=c.map(k,function(a){return a.toString().toLowerCase()});c.each(k,function(a){h.push(a)})}});h=c.uniq(c.without(h,""));c.isEmpty(c.difference(b,h))&&k.push(a)});return k},info:function(){var a={},a=this.sortedAndFilteredModels?this.sortedAndFilteredModels.length:this.length,c=Math.ceil(a/this.perPage),
a={totalUnfilteredRecords:this.origModels.length,totalRecords:a,currentPage:this.currentPage,perPage:this.perPage,totalPages:c,lastPage:c,previous:!1,next:!1,startRecord:0===a?0:(this.currentPage-1)*this.perPage+1,endRecord:Math.min(a,this.currentPage*this.perPage)};1<this.currentPage&&(a.prev=this.currentPage-1);this.currentPage<a.totalPages&&(a.next=this.currentPage+1);a.pageSet=this.setPagination(a);return this.information=a},setPagination:function(a){var c=[],d=0,e=0,e=Math.ceil(a.totalRecords/
a.perPage);if(1<e)if(13>e)for(d=1;d<=e;d++)c.push(d);else if(11<e)if(7>a.currentPage)for(d=1,e=10;d<e;d++)c.push(d);else if(e-6>a.currentPage&&6<a.currentPage)for(d=a.currentPage-3;d<=a.currentPage+3;d++)c.push(d);else for(d=e-8;d<=e;d++)c.push(d);return c}});k.requestPager=l.Collection.extend({sync:function(a,g,d){var e=this;c.defaults(e.paginator_ui,{firstPage:0,currentPage:1,perPage:5,totalPages:10});c.each(e.paginator_ui,function(a,b){c.isUndefined(e[b])&&(e[b]=e.paginator_ui[b])});var f={};c.each(e.server_api,
function(a,b){c.isFunction(a)&&(a=c.bind(a,e),a=a());f[b]=a});var b=c.clone(e.paginator_core);c.each(b,function(a,d){c.isFunction(a)&&(a=c.bind(a,e),a=a());b[d]=a});b=c.defaults(b,{timeout:25E3,cache:!1,type:"GET",dataType:"jsonp"});b=c.extend(b,{jsonpCallback:"callback",data:decodeURIComponent($.param(f)),processData:!1,url:c.result(b,"url")},d);return $.ajax(b)},requestNextPage:function(a){if(void 0!==this.currentPage)return this.currentPage+=1,this.pager(a);a=new $.Deferred;a.reject();return a.promise()},
requestPreviousPage:function(a){if(void 0!==this.currentPage)return this.currentPage-=1,this.pager(a);a=new $.Deferred;a.reject();return a.promise()},updateOrder:function(a){void 0!==a&&(this.sortField=a,this.pager())},goTo:function(a,c){if(void 0!==a)return this.currentPage=parseInt(a,10),this.pager(c);var d=new $.Deferred;d.reject();return d.promise()},howManyPer:function(a){void 0!==a&&(this.currentPage=this.firstPage,this.perPage=a,this.pager())},sort:function(){},info:function(){var a={totalRecords:this.totalRecords||
0,currentPage:this.currentPage,firstPage:this.firstPage,totalPages:this.totalPages,lastPage:this.totalPages,perPage:this.perPage};return this.information=a},pager:function(a){c.isObject(a)||(a={});return this.fetch(a)}});return k});
