<?php echo $this->headLink()->appendStylesheet($this->websiteUrl . 'system/js/external/chosen/chosen.css'); ?>
<div class="container_12">
	<!-- Product listing selector -->
	<div id="template-selector" class="grid_12 mt10px mb5px">
		<?php if(isset($this->productTemplates) && !empty($this->productTemplates)): ?>
			<select id="templates" class="templates" style="width:260px;margin: 3px;float:left;" data-placeholder="Select a product listing template...">
				<option value="0"><?php echo $this->translate('Select a product listing template'); ?></option>
				<?php foreach($this->productTemplates as $template): ?>
					<option value="<?php echo $template->getName(); ?>"><?php echo $template->getName(); ?></option>
				<?php endforeach; ?>
			</select>
		<?php else: ?>
			<h3 class="grid_12"><?php echo $this->translate('Warning! You don\'t have any product listing template. You should create one.'); ?></h3>
		<?php endif; ?>
	</div>

	<!-- Filtering -->
	<div id="filters" class="grid_4">
		<select style="width: 205px;float:left;" name="product-categories" id="categories" multiple class="pselect ui-corner-all" data-placeholder="Filter by categories..."></select>
	</div>
	<div class="grid_4">
		<select style="width: 205px;float:left;" name="product-brands" id="brands" multiple class="pselect ui-corner-all" data-placeholder="Filter by brands..."></select>
	</div>

	<!-- Ordering -->
	<div id="order" class="grid_4">
		<select style="width: 205px;float:left;" name="ordering" id="ordering" multiple class="pselect ui-corner-all" data-placeholder="Order by...">
			<option value="name">Name</option>
			<option value="price">Price</option>
			<option value="brand">Brand</option>
		</select>
	</div>
	<a href="javascript:;" id="btn-create" class="grid_6 mt5px"><?php echo $this->translate('Create an automated product listing'); ?></a>
	<span class="grid_6 mt20px"><?php echo $this->translate('And/or click on items to insert one by one'); ?></span>
	<div style="clear: both;"></div>
	<div id="product-products" class="mt10px"></div>
</div>

<style type="text/css">
	#btn-create {
		background: #ffa500;
		color: #f5f5f5;
		font-weight: bold;
	}

	#prod-perpage {
		width: 120px;
	}

	.chzn-container-multi {
		margin: 5px 3px;
	}

	/*select.pselect {*/
		/*width: 244px;*/
	/*}*/

	#product-products {
		overflow-y: auto;
		background: #fff;
		height: 300px;
	}
	div.productlisting {
        width: 15%;
        height: 120px;
        margin: 3px;
        /*padding: 2px;*/
        float: left;
        border: 2px solid lavender;
        border-radius: 3px 8px;
        overflow: hidden;
        position: relative;
        text-align: center;
        cursor: pointer;
        background: #fff;
        font-size: 9pt;
    }
	div.productlisting img {
		max-height: 60px;
		display: block;
		margin: 1px auto;
	}
    p.brand {
        padding: 2px 0px;
        background-color: lavender;
        margin-bottom: 1px;
        font-weight:bold;
    }
    p.sku{
        text-align: right;
        font-size: 8pt;
        border-top: 1px dashed #eee;
        padding: 4px 0px;
        margin-top: 4px;
        color: #7C7C7C;
        position: absolute;
        bottom: 0px;
        right: 2px;
        width: 100%;
        height: 8pt;
        overflow: hidden;
        background-color:#fff;
    }
</style>
<?php echo $this->headScript()->appendFile($this->websiteUrl . 'system/js/external/chosen/chosen.jquery.min.js'); ?>
<script type="text/javascript" charset="utf-8">
    $(function() {
	    $('.pselect').chosen();
	    $('#btn-create').button();

		$('.ui-tabs-nav-item a').click(function() {
			var childs = $(this).find('span#products');
			if(!childs.length) {
				$('.above-editor-links').switchClass('grid_5', 'grid_8');
				$('#tabs').switchClass('grid_7', 'grid_4');
				$('#product-products').html('');
				$('tr.mceFirst').show();
			}
			else {
				$('#product-products').html('');
				$('.above-editor-links').switchClass('grid_8', 'grid_3');
				$('#tabs').switchClass('grid_4', 'grid_9');

		        //hiding mce controls
		        $('tr.mceFirst').hide();
				$('#tabs-frag-3').addClass('h450');
				$('table#content_tbl').width('230px');

		        //loading store data
		        loadStoreData('categories');
				loadStoreData('brands');
				loadProducts();

		        //little chosen plugin make up
				$('ul.chzn-choices').removeClass('ui-corner-top').addClass('ui-corner-all');
			}
		})

		$('.currproduct').live('click', function() {
			var tpl = $('#templates').val();
			if(tpl == 0) {
				showModalMessage('Product template is missing', 'Please select a product listing template', null, true);
				return false;
			}
			$('textarea.tinymce').tinymce().execCommand('mceInsertContent',false, '{$product:' + $(this).attr('id') + ((tpl) ? ':' + tpl : '') + '}');
		});

		$('#btn-create').live('click', function() {
			var shortCode = '{$productlist:';
			if($('#templates').val() == 0) {
				showModalMessage('Product template is missing', 'Please select a product listing template', null, true);
				return false;
			}
			//listing template
			shortCode += $('#templates').val();
			//categories filter
			shortCode += (($('#categories').val() != null) ? ':categories-' + $('#categories').val() : '');
			//brands filter
			shortCode += (($('#brands').val() != null) ? ':brands-' + $('#brands').val() : '');
			//ordering
			shortCode += (($('#ordering').val() != null) ? ':order-' + $('#ordering').val() : '') + '}';

			$('textarea.tinymce').tinymce().execCommand('mceInsertContent', false, shortCode);
		})

	    $('.pselect').chosen().change(filter);

    });

	function loadStoreData(type) {
		$.getJSON('<?php echo $this->websiteUrl; ?>plugin/shopping/run/getdata/type/' + type, function(response) {
            if(response.length && !($('#' + type + ' option').length)) {
				$.each(response, function() {
					$('#' + type).append(
						$('<option></option>').val((type == 'categories') ? this.id : this.name).text(this.name)
					);
				});
				$('.pselect').trigger("liszt:updated");
			}
        })
	}

	function loadProducts() {
		$.getJSON('<?php echo $this->websiteUrl; ?>plugin/shopping/run/getdata/type/product', function(response) {
            if(response.length) {
				$.each(response, function() {
					var productItem  = '';
					var photoDetails = this.photo.split('/');
					productItem     += '<div class="productlisting"><a href="javascript:;" class="currproduct" id="' + this.id + '"  title="' + this.name + '">' +
						'<p class="brand">' + this.brand + '</p>' +
						'<img src="' + '<?php echo $this->websiteUrl; ?>media/' + photoDetails[0] + '/product/' + photoDetails[1] + '" alt="' + this.name + '">' + this.name + '</a><p class="sku">' + this.sku + '</p></div>';
					$('#product-products').append(productItem);
				});
			}
        })
	}

	function filter() {
		var categories = $('#categories').val();
		var brands     = $('#brands').val();
		$.getJSON('<?php echo $this->websiteUrl; ?>plugin/shopping/run/getdata/type/product', {
			fcat   : categories,
			fbrand : brands
		}, function(response) {
			if(response.length) {
				$('#product-products').html('');
				$.each(response, function() {
					var productItem = '';
					var photoDetails = this.photo.split('/');
					productItem     += '<div class="productlisting"><a href="javascript:;" class="currproduct" id="' + this.id + '"  title="' + this.name + '"><div class="details">' +
						'<p class="brand">' + this.brand + '</p><p class="sku">' + this.sku + '</p></div>' +
						'<img src="' + '<?php echo $this->websiteUrl; ?>media/' + photoDetails[0] + '/product/' + photoDetails[1] + '" alt="' + this.name + '">' + this.name + '</a></div>';
					$('#product-products').append(productItem);
				});
			}
			else {
				$('#product-products').html('');
			}
		})
	}
</script>
